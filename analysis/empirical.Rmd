---
title: "Empirical use-resistance relationships over geographic scales"
author: "Scott Olesen"
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(
  fig.width = 7, fig.height = 4, fig.path = 'fig/',
  dev = c('png', 'pdf'),
  echo = FALSE, warning = FALSE, message = FALSE,
  cache = TRUE, autodep = TRUE)

pdf.options(useDingbats = FALSE, useKerning = FALSE)

library(MASS)
map = purrr::map
select = dplyr::select
```

# Methods

## Use and resistance data

### MarketScan

```{r maup_db}
state_data = read_tsv('../db/state_data.tsv') %>%
  rename(us_region = region, us_division = division) %>%
  mutate(density = population / area)
```

```{r marketscan_data}
marketscan_res = read_tsv('~/grad/proj/medicare/analysis/ms2/data/abg_state.tsv', col_types = cols('n_isolates' = 'n')) %>%
  # specify n_isolates as "n" to parse things like "5e3"
  mutate_at('n_isolates', as.integer) %>%
  rename(drug = drug_group) %>%
  mutate(bugdrug = case_when(
    .$bug == 'E. coli' & .$drug == 'quinolone' ~ 'Ec/q',
    .$bug == 'S. pneumoniae' & .$drug == 'beta_lactam' ~ 'Sp/bl',
    .$bug == 'S. pneumoniae' & .$drug == 'macrolide' ~ 'Sp/m'
  )) %>%
  filter(!is.na(bugdrug)) %>%
  mutate(n_resistant = as.integer(round(f_ns * n_isolates))) %>%
  select(bugdrug, drug, state, n_resistant, n_isolates)

marketscan_use = read_tsv('~/grad/proj/medicare/analysis/ms2/ineq_marketscan.tsv') %>%
  rename(drug = drug_group, use = total_use) %>%
  filter(drug %in% c('quinolone', 'beta_lactam', 'macrolide'))

marketscan = marketscan_use %>%
  inner_join(marketscan_res, by = c('drug', 'state')) %>%
  rename(unit = state) %>%
  left_join(state_data, by = 'unit') %>%
  select(
    unit, bugdrug, use, n_resistant, n_isolates,
    population, density, income, temperature,
    us_region, us_division
  )
```

### NHSN/IMS

```{r nhsn_ims}
nhsn = read_tsv('../data/nhsn-ims/data.tsv') %>%
  rename(state_abbreviation = state) %>%
  filter(state_abbreviation %in% state.abb) %>%
  mutate(
    unit_id = match(state_abbreviation, state.abb),
    bugdrug = 'Ec/q',
    use = rx_1k_year / 1e3
  ) %>%
  left_join(state_data, by = 'unit_id') %>%
  select(
    unit, bugdrug, use, n_resistant, n_isolates,
    population, density, income, temperature,
    us_region, us_division
  )
```

### ECDC

For the European data, we convert to "treatments" per person per year, assuming a certain conversion from DDD to treatments. This is just an *ad hoc* adjustment to get the European data to the same scales as used in the simulations and the US data.

```{r ecdc_convert}
did_cpy_map = data_frame(
  drug = c('beta_lactam', 'quinolone', 'macrolide'),
  ddd_per_tx = c(10, 10, 7),
  cpy_per_did = 365 / (1e3 * ddd_per_tx)
)

did_cpy_map %>%
  kable(caption = 'DDD to treatment conversion')
```

```{r ecdc}
europe_units = read_tsv('../db/europe_units.tsv') %>%
  mutate(density = population / area) %>%
  select(unit_id, unit, population, eu_region = region, density, income, temperature)

europe = read_tsv('../data/ecdc/data.tsv') %>%
  left_join(did_cpy_map, by = 'drug') %>%
  mutate(use = cpy_per_did * did) %>%
  mutate(bugdrug = case_when(
    .$bug == 'Escherichia coli' & .$drug == 'quinolone' ~ 'Ec/q',
    .$bug == 'Streptococcus pneumoniae' & .$drug == 'beta_lactam' ~ 'Sp/bl',
    .$bug == 'Streptococcus pneumoniae' & .$drug == 'macrolide' ~ 'Sp/m'
  )) %>%
  rename(unit = country) %>%
  left_join(europe_units, by = 'unit') %>%
  select(
    unit, bugdrug, use, n_resistant = n_ns, n_isolates,
    population, density, temperature, income,
    eu_region
  )

europe_names = unique(europe$unit)
```

```{r combine_data}
named_bind_rows = function(..., label = 'dataset') {
  names = map_chr(quos(...), quo_name)
  map2_dfr(list(...), names, ~ mutate(.x, !!as.symbol(label) := .y))
}

unit_data = named_bind_rows(marketscan, nhsn, europe) %>%
  mutate(
    n_susceptible = n_isolates - n_resistant,
    f_resistant = n_resistant / n_isolates
  ) %>%
  nest(-dataset, -bugdrug)
```

## Adjacency

```{r adjacency_db}
us_adjacency = read_tsv('../db/state_adjacency.tsv')
eu_adjacency = read_tsv('../db/europe_adjacency.tsv')

# swo: need to mirror this, based on how the crossing function is written
commuting_db <- read_tsv('../db/us/commuting/commuting.tsv') %>%
  rename_all(~ str_replace(., '^state', 'unit'))
```

# Results

## Adjacency analysis

A state is too small a unit if resistance/susceptibility seems to be spilling over between states. As a first step, ask if use/relationships are weaker (more "spilled over") in physically adjacent pairs of states.

```{r distance_analysis_helpers}
# because no US states and European countries share names, it's OK to combine this list
adjacency_db <- bind_rows(us_adjacency, eu_adjacency) %>%
  mutate(adjacent = 1)

odds <- function(p) p / (1 - p)
log_odds_ratio <- function(p, q) log(odds(p)) - log(odds(q))

cross_units <- function(df) {
  df %$%
    crossing(unit1 = unit, unit2 = unit) %>%
    left_join(rename_all(df, ~ str_c(., '1')), by = 'unit1') %>%
    left_join(rename_all(df, ~ str_c(., '2')), by = 'unit2') %>%
    filter(unit1 < unit2) %>%
    mutate(
      d_resistant = f_resistant1 - f_resistant2,
      d_use = use1 - use2,
      d_income = income1 - income2,
      d_density = density1 - density2,
      d_temperature = temperature1 - temperature2,
      dr_du = d_resistant / d_use,
      lor_resistant = log_odds_ratio(f_resistant1, f_resistant2),
      lorr_du = lor_resistant / d_use
    ) %>%
    select(unit1, unit2, starts_with('d_'), dr_du, starts_with('lor')) %>%
    # pairs of units not in the adjacency list are not adjacent
    left_join(adjacency_db, by = c('unit1', 'unit2')) %>%
    replace_na(list(adjacent = 0)) %>%
    left_join(commuting_db, by = c('unit1', 'unit2')) %>%
    replace_na(list(f_commuting = 0))
}

permute_cross_units <- function(df) {
  idx <- sample(nrow(df))
  df %>%
    mutate_at(
      c('n_resistant', 'n_isolates', 'n_susceptible', 'f_resistant'),
      ~ .[idx]
    ) %>%
    cross_units()
}

# compute indices, models, and predictions
adjacency_permute_f = function(df, model_f, stat_f, n_trials = 1e3 - 1, alpha = 0.05) {
  base_data <- cross_units(df)
  base_model <- model_f(base_data)
  base_statistic <- stat_f(base_model)
  
  results <- tibble(
    # shuffle data sets
    cross_data = rerun(n_trials, permute_cross_units(df)),
    # run the model and predict the outcomes
    model = map(cross_data, model_f),
    statistic = map_dbl(model, stat_f)
  )
  
  list(
    base_data = base_data,
    base_model = base_model,
    base_statistic = base_statistic,
    statistic_cil = quantile(results$statistic, alpha / 2),
    statistic_ciu = quantile(results$statistic, 1 - alpha / 2),
    # small stat => group 0 had smaller values
    p_value = (sum(base_statistic < results$statistic) + 1) / (n_trials + 1)
  )
}

adjacency_analysis <- function(model_f, stat_f) {
  unit_data %>%
    mutate(results = map(data, ~ adjacency_permute_f(
      ., model_f, stat_f
    )))
}

adjacency_results_table <- function(results) {
  results %>%
    select(-data) %>%
    mutate(
      statistic = map_dbl(results, ~ .$base_statistic),
      cil = map_dbl(results, ~ .$statistic_cil),
      ciu = map_dbl(results, ~ .$statistic_ciu),
      p_value = map_dbl(results, ~ .$p_value)
    ) %>%
    select(bugdrug, dataset, statistic, cil, ciu, p_value)
}
```

```{r adjacency_analysis}
adjacency_results <- adjacency_analysis(
  function(data) wilcox.test(dr_du ~ adjacent, data = data),
  function(model) model$statistic
)
```

```{r adjacency_results}
adjacency_results %>%
  adjacency_results_table()
```

```{r adjacency_plot}
boxplot_data_f <- function(df, ymin, ymax) {
  df %>%
    nest(-adjacent) %>%
    mutate(
      y = map(data, ~ .$dr_du),
      box = map(y, ~ boxplot.stats(.)$stats),
      boxplot_data = map(box, ~ tibble(
        ymin = max(.[1], ymin),
        lower = .[2],
        middle = .[3],
        upper = .[4],
        ymax = min(.[5], ymax)
      ))
    ) %>%
    select(adjacent, boxplot_data) %>%
    unnest()
}

f_to_keep <- 0.90
half_drop <- (1 - f_to_keep) / 2
plot_data <- adjacency_results %>%
  mutate(
    data = map(results, ~ .$base_data),
    y = map(data, ~ .$dr_du),
    ymin = map_dbl(y, ~ quantile(., half_drop)),
    ymax = map_dbl(y, ~ quantile(., 1 - half_drop)),
    boxplot_data = pmap(list(data, ymin, ymax), boxplot_data_f),
    point_data = pmap(list(data, ymin, ymax), ~ filter(..1, between(dr_du, ..2, ..3))),
    # some plotting niceties
    dataset = recode(dataset,
      'europe' = 'ECDC',
      'marketscan' = 'MarketScan/RO',
      'nhsn' = 'Xponent/NHSN'
    ),
    label = str_c(dataset, ' ', bugdrug)
  )

point_data <- plot_data %>%
  select(label, point_data) %>%
  unnest()

boxplot_data <- plot_data %>%
  select(label, boxplot_data) %>%
  unnest()

ggplot(data = NULL, aes(x = factor(adjacent))) +
  facet_wrap(~ label, scales = 'free_y') +
  geom_boxplot(
    data = boxplot_data,
    aes(lower = lower, upper = upper, middle = middle, ymin = ymin, ymax = ymax),
    stat = 'identity'
  ) +
  geom_jitter(data = point_data, aes(y = dr_du), size = 0.1, width = 0.2) +
  scale_x_discrete(
    '',
    breaks = c(0, 1),
    labels = c('Not adjacent', 'Adjacent')
  ) +
  ylab('Use-resistance association') +
  theme_classic() +
  theme(
    strip.text = element_text(size = 8),
    strip.background = element_blank(),
    axis.text = element_text(size = 8, color = 'black'),
    axis.title = element_text(size = 8)
  )
```

## Adjacency with covariates

```{r adjacency_covariates_analysis}
bisquare <- partial(MASS::rlm, psi = MASS::psi.bisquare)

adjacency_covariates_results <- adjacency_analysis(
    function(data) bisquare(dr_du ~ adjacent + d_income + d_density + d_temperature, data = data),
    function(model) coef(model)['adjacent']
)

adjacency_covariates_results %>%
  adjacency_results_table() %>%
  kable()
```

### Adjacency, covariates, with LOR

```{r adjacency_covariates_lor_analysis}
adjacency_covariates_lor_results <- adjacency_analysis(
    function(data) bisquare(lorr_du ~ adjacent + d_income + d_density + d_temperature, data = data),
    function(model) coef(model)['adjacent']
)

adjacency_covariates_lor_results %>%
  adjacency_results_table() %>%
  kable()
```

## Commuting analysis with covariates

```{r commuting_analysis}
commute_model_f <- safely(function(data) {
  bisquare(dr_du ~ f_commuting + d_income + d_density + d_temperature, data = data)
})

commute_lor_f <- safely(function(data) {
  bisquare(lorr_du ~ f_commuting + d_income + d_density + d_temperature, data = data)
})

commute_stat_f <- function(model) {
  if (is.null(model$result)) {
    NA_real_
  } else {
    coef(model$result)['f_commuting']
  }
}

commuting_results <- unit_data %>%
  filter(dataset != 'europe') %>%
  mutate(
    results = map(data, ~ adjacency_permute_f(., commute_model_f, commute_stat_f)),
    results_lor = map(data, ~ adjacency_permute_f(., commute_lor_f, commute_stat_f))
  )

commuting_results %>%
  mutate(
    p_value = map_dbl(results, ~ .$p_value),
    p_value_lor = map_dbl(results_lor, ~ .$p_value)
  ) %>%
  select(bugdrug, dataset, p_value, p_value_lor) %>%
  kable()
```

```{r commute_plot}
not_crazy <- function(x) between(x, quantile(x, 0.025), quantile(x, 0.975))

unit_data %>%
  filter(dataset != 'europe') %>%
  mutate(
    data = map(data, cross_units),
    data = map(data, ~ filter(., not_crazy(dr_du))),
    dataset = recode(dataset,
      'europe' = 'ECDC',
      'marketscan' = 'MarketScan/RO',
      'nhsn' = 'Xponent/NHSN'
    ),
    label = str_c(dataset, ' ', bugdrug)
  ) %>%
  unnest() %>%
  ggplot(aes(f_commuting, dr_du)) +
  facet_wrap(~ label) +
  geom_hline(yintercept = 0, color = 'gray', size = 1) +
  geom_point() +
  scale_x_log10('Fraction of workers commuting between states') +
  theme_classic()
```

## Commuting without covariates

```{r commute1}
commute_model_f1 <- safely(function(data) {
  bisquare(dr_du ~ f_commuting, data = data)
})

commute_lor_f1 <- safely(function(data) {
  bisquare(lorr_du ~ f_commuting, data = data)
})

commuting_results1 <- unit_data %>%
  filter(dataset != 'europe') %>%
  mutate(
    results = map(data, ~ adjacency_permute_f(., commute_model_f1, commute_stat_f)),
    results_lor = map(data, ~ adjacency_permute_f(., commute_lor_f1, commute_stat_f))
  )

commuting_results1 %>%
  mutate(
    p_value = map_dbl(results, ~ .$p_value),
    p_value_lor = map_dbl(results_lor, ~ .$p_value)
  ) %>%
  select(bugdrug, dataset, p_value, p_value_lor) %>%
  kable()
```

## Plots

First plot shows MS/RO and Sp/m.

```{r distance_plots, eval = FALSE}
main_distance_plot_data = distance_results %>%
  filter(dataset == 'marketscan', bugdrug == 'Sp/m') %$%
  pair_data[[1]] %>%
  mutate(adjacent = adjacent == 1)
  
main_distance_pred_data = distance_results %>%
  filter(dataset == 'marketscan', bugdrug == 'Sp/m') %$%
  pred_data[[1]] %>%
  mutate(adjacent = adjacent == 1)

main_distance_plot = ggplot(data = NULL, aes(d_use, d_resistant, color = adjacent, fill = adjacent)) +
  geom_ribbon(
    data = main_distance_pred_data,
    aes(ymin = ymin, ymax = ymax, color = NULL),
    alpha = 0.25
  ) + 
  geom_line(data = main_distance_pred_data) +
  geom_point(data = main_distance_plot_data, shape = 1) +
  scale_color_manual(values = c('black', 'red')) +
  scale_fill_manual(values = c('black', 'red')) +
  xlab('Difference in antibiotic use (annual treatments per capita)') +
  ylab('Difference in resistance (log odds ratio)') +
  theme_classic() +
  theme(
    legend.position = 'none',
    axis.text = element_text(size = 8, color = 'black'),
    axis.title = element_text(size = 8)
  )

show(main_distance_plot)

other_distance_plot_data = distance_results %>%
  filter(!(dataset == 'marketscan' & bugdrug == 'Sp/m')) %>%
  select(dataset, bugdrug, pair_data) %>%
  unnest() %>%
  mutate(
    adjacent = adjacent == 1,
    dataset = recode(dataset, 'europe' = 'ECDC', 'marketscan' = 'MarketScan/RO', 'nhsn' = 'Xponent/NHSN'),
    label = str_c(dataset, ' ', bugdrug)
  )

other_distance_pred_data = distance_results %>%
  filter(!(dataset == 'marketscan' & bugdrug == 'Sp/m')) %>%
  select(dataset, bugdrug, pred_data) %>%
  unnest() %>%
  mutate(
    adjacent = adjacent == 1,
    dataset = recode(dataset, 'europe' = 'ECDC', 'marketscan' = 'MarketScan/RO', 'nhsn' = 'Xponent/NHSN'),
    label = str_c(dataset, ' ', bugdrug)
  )

other_distance_plot = ggplot(
  data = NULL, aes(d_use, d_resistant, color = adjacent, fill = adjacent)
) +
  facet_wrap(~ label, scales = 'free') +
  geom_ribbon(
    data = other_distance_pred_data,
    aes(ymin = ymin, ymax = ymax, color = NULL), alpha = 0.25
  ) + 
  geom_line(data = other_distance_pred_data) +
  geom_point(data = other_distance_plot_data, shape = 1, size = 0.5) +
  scale_color_manual(values = c('black', 'red')) +
  scale_fill_manual(values = c('black', 'red')) +
  xlab('Difference in antibiotic use (annual treatments per capita)') +
  ylab('Difference in resistance (log odds ratio)') +
  theme_classic() +
  theme(
    legend.position = 'none',
    strip.text = element_text(size = 8),
    strip.background = element_blank(),
    axis.text = element_text(size = 8, color = 'black'),
    axis.title = element_text(size = 8)
  )

show(other_distance_plot)

ggsave(
  'fig/main_distance_plot.pdf',
  plot = main_distance_plot,
  width = 88, height = 80, units = 'mm'
)

ggsave(
  'fig/other_distance_plot.pdf',
  plot = other_distance_plot,
  width = 180, height = 80, units = 'mm'
)
```
