---
title: "Empirical use-resistance relationships over geographic scales"
author: "Scott Olesen"
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  fig.width=7, fig.height=4, fig.path='fig/',
  dev=c('png', 'pdf'),
  echo=FALSE, warning=FALSE, message=FALSE,
  cache=TRUE, autodep=TRUE)
pdf.options(useDingbats=FALSE, useKerning=FALSE)
```

# US/Europe conversions

Most of the US studies and data are measured in prescriptions (or claims) per 1,000 people per year (PIY); the European studies are usually in DID (DDD per 1,000 people per year). Converting between the two requires asserting how many DDD are in one prescription.

I got these numbers by (1) looking in MarketScan and computing the average days' supply for claims for each drug and (2) comparing the CDDEP's within-US numbers (in PIY) with their across-country values for the US (in DID). They seem to disagree somewhat on the $\beta$-lactams. Something to be looked into a little more.

```{r piy_did}
us_europe_crosswalk = data_frame(
  drug = c('beta_lactam', 'quinolone', 'macrolide'),
  ddd_per_rx = c(10, 10, 7)
)

kable(us_europe_crosswalk)

# PIY = Prescriptions per 1,000 Inhabitants per Year
us_europe_convert = function(drug_, piy) {
  us_europe_crosswalk %$%
    { piy / 365 * ddd_per_rx[match(drug_, drug)] }
}
```

# Medicare & ResistanceOpen

This is a nice chance to ask if going to a smaller scale gives you different regression coefficients. I compare the slopes of the use/resistance relationship when using HRRs and states.

```{r medicare_ro}
ro_bugdrugs = data_frame(
  bug = c('S. pneumoniae', 'S. pneumoniae', 'E. coli'),
  drug_group = c('beta_lactam', 'macrolide', 'quinolone')
)

ro_state = read_tsv('../data/ms-medicare-ro/abg_state.tsv')
ro_hrr = read_tsv('../data/ms-medicare-ro/abg_hrr.tsv')

medicare_state_use = read_tsv('../data/ms-medicare-ro/ineq_medicare_state.tsv')
medicare_hrr_use = read_tsv('../data/ms-medicare-ro/ineq_medicare_hrr.tsv')

medicare_state = inner_join(medicare_state_use, ro_state, by=c('drug_group', 'state')) %>%
  inner_join(ro_bugdrugs) %>%
  mutate(dataset='Medicare (state)',
         pct_res=100*f_ns,
         did = us_europe_convert(drug_group, total_use * 1000)) %>%
  select(dataset, bug, drug=drug_group, geo_unit=state, did, pct_res)

medicare_hrr = inner_join(medicare_hrr_use, ro_hrr, by=c('drug_group', 'hrr')) %>%
  inner_join(ro_bugdrugs) %>%
  mutate(dataset='Medicare (HRR)',
         pct_res=100*f_ns,
         did = us_europe_convert(drug_group, total_use * 1000),
         geo_unit = as.character(hrr)
         ) %>%
  select(dataset, bug, drug=drug_group, geo_unit, did, pct_res)

medicare_state_models = medicare_state %>%
  group_by(bug, drug) %>%
  do(tidy(lm(pct_res ~ did, data=.), conf.int=TRUE)) %>%
  ungroup()

medicare_hrr_models = medicare_hrr %>%
  group_by(bug, drug) %>%
  do(tidy(lm(pct_res ~ did, data=.), conf.int=TRUE)) %>%
  ungroup()
```

```{r ms}
marketscan = read_tsv('~/grad/proj/medicare/analysis/ms2/ineq_marketscan.tsv') %>%
  inner_join(ro_state, by=c('drug_group', 'state')) %>%
  inner_join(ro_bugdrugs) %>%
  mutate(did = us_europe_convert(drug_group, total_use * 1000)) %>%
  mutate(dataset='MarketScan', pct_res=100 * f_ns) %>%
  select(dataset, bug, drug=drug_group, geo_unit=state, did, pct_res)
```

To the eye, it looks like the state and HRR points lie on similar lines:

```{r}
bind_rows(
  medicare_state %>% mutate(level='state'),
  medicare_hrr %>% mutate(level='hrr')
) %>%
  ggplot(aes(did, pct_res, color=level)) +
  facet_wrap(~ bug + drug, scales='free_x') +
  geom_point() +
  geom_smooth(method='lm')
```

Looking at just the regression results emphasizes that:

```{r}
bind_rows(
  medicare_state_models %>% mutate(level='state'),
  medicare_hrr_models %>% mutate(level='hrr')
) %>%
  filter(term == 'did') %>%
  ggplot(aes(level, estimate, ymin=conf.low, ymax=conf.high)) +
  facet_wrap(~ bug + drug) +
  geom_point() +
  geom_errorbar()
```

And I could do something more sophisticated, by running a model $\rho ~ \tau$ and another one $\rho ~ \tau + \tau \times L$, where $L$ is a dummy variable encoding whether the level of the analysis is state or HRR. All those interaction terms are not statistically significant.

```{r}
bind_rows(
  medicare_state %>% mutate(level='state'),
  medicare_hrr %>% mutate(level='hrr')
) %>%
  mutate(at_hrr = as.integer(level == 'hrr')) %>%
  group_by(bug, drug) %>%
  do(tidy(lm(did ~ pct_res * at_hrr, data=.), conf.int=TRUE)) %>%
  select(-std.error, -statistic) %>%
  filter(term == 'pct_res:at_hrr')
```

# Data sets

## Arason

```{r arason}
arason_r = read_tsv('../data/arason/resistance.tsv') %>%
  group_by(area_code) %>%
  summarize_at(vars(starts_with('n')), sum) %>%
  mutate(n_isolates = n_resistant + n_sensitive,
         pct_res = 100 * n_resistant / n_isolates)

arason_u = read_tsv('../data/arason/use.tsv') %>%
  mutate(did = did_penV + did_amoxclav) %>%
  select(area_code, did)

arason = inner_join(arason_r, arason_u, by='area_code') %>%
  mutate(dataset='Arason', bug='S. pneumoniae', drug='beta_lactam') %>%
  select(dataset, bug, drug, geo_unit=area_code, did, pct_res, n_isolates)
```

## Bronzwaer

```{r bronzwaer}
bronzwaer = read_tsv('../data/bronzwaer/use_resistance.tsv') %>%
  mutate(pct_res = 100 * n_nonsusceptible / n_isolates) %>%
  mutate(dataset='Bronzwaer', bug='S. pneumoniae', drug='beta_lactam') %>%
  select(dataset, bug, drug, geo_unit=country, did=did_betalactam, did=did_betalactam, pct_res, n_isolates)
```

## ECDC

```{r ecdc}
rename_bug = function(x) {
  sapply(x, function(y) {
    switch(y, 'Escherichia coli'='E. coli', 'Streptococcus pneumoniae'='S. pneumoniae', y)
  })
}

ecdc = read_tsv('../data/ecdc/data.tsv') %>%
  mutate(bug = rename_bug(bug),
         pct_res = 100 * f_ns,
         dataset='ECDC') %>%
  select(dataset, bug, drug, geo_unit=country, did, pct_res)
```

## Pihljamaki

```{r pihljamaki}
pihljamaki_pen = read_tsv('../data/pihljamaki/penicillins.tsv') %>%
  mutate(dataset='Pihljamaki', bug='S. pneumoniae', drug='beta_lactam', geo_unit=as.character(1:n())) %>%
  select(dataset, bug, drug, geo_unit, did=did_pen, pct_res=pct_res_pen)

pihljamaki_macro = read_tsv('../data/pihljamaki/macrolides.tsv') %>%
  mutate(dataset='Pihljamaki', bug='S. pneumoniae', drug='macrolide', geo_unit=as.character(1:n())) %>%
  select(dataset, bug, drug, geo_unit, did=did_macrolide, pct_res=pct_res_erythro)

pihljamaki = bind_rows(pihljamaki_pen, pihljamaki_macro)
```

## Goossens

```{r goossens}
goossens = read_tsv('../data/goossens/data.tsv') %>%
  mutate(dataset='Goossens', bug='S. pneumoniae', drug='beta_lactam') %>%
  select(dataset, bug, drug, geo_unit=country, did, pct_res=pct_nonsusceptible)
```

## Kahlmeter

```{r kalhmeter}
kahlmeter = inner_join(
  read_tsv('../data/kahlmeter/resistance.tsv') %>% filter(drug=='CIP'),
  read_tsv('../data/kahlmeter/use.tsv') %>% group_by(country) %>% summarize(did=mean(did)),
  by='country'
) %>%
  mutate(dataset='Kahlmeter', bug='E. coli', drug='quinolone') %>%
  select(dataset, bug, drug, geo_unit=country, did, pct_res, n_isolates=n)
```

## NHSN/IMS

Requires assuming a 10x conversion factor

```{r nhsn_ims}
nhsn = read_tsv('../data/nhsn-ims/data.tsv') %>%
  mutate(dataset='NHSN/IMS', bug='E. coli', drug='quinolone',
         pct_res = 100 * n_resistant / n_isolates,
         did = us_europe_convert(drug, rx_1k_year)) %>%
  select(dataset, bug, drug, geo_unit=state, did, pct_res, n_isolates)
```

## CDDEP

```{r cddep}
cddep = read_tsv('../data/cddep/use_res.tsv') %>%
  mutate(dataset='CDDEP',
         bug = rename_bug(bug),
         drug_group = if_else(drug_group == 'penicillin', 'beta_lactam', drug_group),
         did = us_europe_convert(drug_group, rx_1k_year)) %>%
  select(dataset, bug, drug=drug_group, geo_unit=division, did, pct_res=pct_resistant)
```

## Garcia-Rey 2002

```{r garcia_rey2002}
gr2_raw = read_tsv('../data/garcia-rey2002/data.tsv') %>%
  select(province, n_isolates,
         did_bl_total, pct_res_pen,
         did_macrolide_total, pct_res_erythro) %>%
  gather('key', 'value', -province)

# use and resistance data
gr2_ur = gr2_raw %>%
  filter(key != 'n_isolates') %>%
  mutate(
    drug = case_when(
      str_detect(.$key, '(bl|pen)') ~ 'beta_lactam',
      str_detect(.$key, '(macrolide|erythro)') ~ 'macrolide',
      TRUE ~ NA_character_),
    metric = case_when(
      str_detect(.$key, 'did') ~ 'did',
      str_detect(.$key, 'pct_res') ~ 'pct_res',
      .$key == 'n_isolates' ~ 'n_isolates'
    )
  ) %>%
  select(-key) %>%
  spread(metric, value)

# number of isolates
gr2_ni = gr2_raw %>%
  filter(key == 'n_isolates') %>%
  select(province, n_isolates=value)

garciarey2002 = inner_join(gr2_ur, gr2_ni, by='province') %>%
  mutate(dataset='Garcia-Rey 2002', bug='S. pneumoniae') %>%
  select(dataset, bug, drug, geo_unit=province, did, pct_res, n_isolates)
```

## Garcia-Rey 2004

Units in the paper are "units per 1,000 inhabitants per year". So clearly need to divide by 365, but I also don't know how to convert "units" to DDD. So I think I should dropp this study, which isn't bad, since I have the 2002 version from the same data stream.

```{r, eval=FALSE}
gr4_raw = read_tsv('../data/garcia-rey2004/data.tsv')

gr4_ni = gr4_raw %>%
  select(province, n_isolates)

gr4_bl = gr4_raw %>%
  mutate(drug = 'beta_lactam',
         pct_res = n_res_pen,
         did = did_beta_lactams / 365) %>%
  select(province, drug, pct_res, did)

gr4_macro = gr4_raw %>%
  mutate(drug = 'macrolide',
         pct_res = n_res_erythro,
         did = did_macrolides / 365) %>%
  select(province, drug, pct_res, did)

garciarey2004 = bind_rows(gr4_bl, gr4_macro) %>%
  left_join(gr4_ni, by='province') %>%
  mutate(did = case_when(
    .$drug == 'beta_lactam' ~ 19 * .$did,
    .$drug == 'macrolide' ~ 7 * .$did
  )) %>%
  mutate(dataset='Garcia-Rey 2004', bug='S. pneumoniae') %>%
  select(dataset, bug, drug, geo_unit=province, did, pct_res, n_isolates)
```

## Combined figure

```{r}
comb = bind_rows(arason, bronzwaer, ecdc, pihljamaki, goossens, kahlmeter, nhsn, cddep, garciarey2002,
                 #medicare_state, medicare_hrr,
                 marketscan) %>%
  mutate(bugdrug = case_when(
    .$bug == 'E. coli' & .$drug == 'quinolone' ~ 'Ec/q',
    .$bug == 'S. pneumoniae' & .$drug == 'beta_lactam' ~ 'Sp/bl',
    .$bug == 'S. pneumoniae' & .$drug == 'macrolide' ~ 'Sp/m'
  ))

data_plot_f = function(bugdrug_) {
  comb %>%
    filter(dataset != 'Medicare (HRR)', bugdrug == bugdrug_) %>%
    ggplot(aes(did, pct_res, color=dataset)) +
    stat_smooth(method='lm', fullrange=TRUE, se=FALSE, size=1) +
    stat_smooth(method='lm', fullrange=TRUE, geom='ribbon', linetype=2, fill=NA) +
    geom_point(shape=1) +
    ggtitle(bugdrug_)
}

data_plot_f('Ec/q')
data_plot_f('Sp/bl')
data_plot_f('Sp/m')
```

```{r}
models = comb %>%
  group_by(dataset, bugdrug) %>%
  do(tidy(lm(pct_res ~ did, data=.), conf.int=TRUE)) %>%
  ungroup()

plot_f_f = function(term_, xlab_) {
  function(bugdrug_) {
    models %>%
      filter(term==term_, bugdrug==bugdrug_) %>%
      mutate(dataset = fct_reorder(factor(dataset), estimate)) %>%
      ggplot(aes(y=dataset, x=estimate, xmin=conf.low, xmax=conf.high)) +
      geom_vline(xintercept=0, color='black', linetype=2) +
      geom_point() + geom_errorbarh() +
      xlab(xlab_) +
      ylab('') +
      ggtitle(bugdrug_)
  }
}

did_plot_f = plot_f_f('did', 'regression coefficient (p.p. resistance / DID)')
intercept_plot_f = plot_f_f('(Intercept)', 'regression intercept (% resistant)')

did_plot_f('Ec/q')
did_plot_f('Sp/bl')
did_plot_f('Sp/m')

intercept_plot_f('Ec/q')
intercept_plot_f('Sp/bl')
intercept_plot_f('Sp/m')
```

## Mixed models

I use mixed models as a way to summarize these data. Each study has an intercept and slope that are drawn from some true populations that we try to estimate.

```{r}
mixed_models = comb %>%
  group_by(bugdrug) %>%
  do(tidy(lme4::lmer(pct_res ~ did + (did | dataset), data=.), conf.int=TRUE)) %>%
  ungroup()

bind_rows(
  models %>% mutate(type = 'study'),
  mixed_models %>% mutate(type = 'summary', dataset='Mixed model')
) %>%
  filter(term == 'did') %>%
  ggplot(aes(y=dataset, x=estimate)) +
  geom_vline(xintercept = 0, color='gray', linetype=2) +
  geom_point(aes(shape=type, size=type)) +
  scale_shape_manual(values=c(16, 18)) +
  scale_size_manual(values=c(2, 6)) +
  geom_errorbarh(aes(xmin=conf.low, xmax=conf.high), height=0.5) +
  facet_grid(type ~ bugdrug, scales='free', space='free_y')
```

There's not enough studies to properly ask whether geographical scale has an effect on the model performance. I think it's better to just do something qualitative, to say that we don't see an obvious signal in these larger studies, but we see, in our stuff, that grouping states into 9-state groups is fine.

# MAUP

```{r}
maup_res = read_tsv('~/grad/proj/medicare/analysis/ms2/data/abg_state.tsv') %>%
  rename(drug=drug_group) %>%
  mutate(bugdrug = case_when(
    .$bug == 'E. coli' & .$drug == 'quinolone' ~ 'Ec/q',
    .$bug == 'S. pneumoniae' & .$drug == 'beta_lactam' ~ 'Sp/bl',
    .$bug == 'S. pneumoniae' & .$drug == 'macrolide' ~ 'Sp/m'
  )) %>%
  filter(!is.na(bugdrug)) %>%
  mutate(n_res = as.integer(round(f_ns * n_isolates))) %>%
  select(bugdrug, drug, state, n_res, n_isolates)

maup_use = read_tsv('~/grad/proj/medicare/analysis/ms2/data/marketscan_abxdist.tsv') %>%
  rename(drug=drug_group) %>%
  filter(drug %in% c('quinolone', 'beta_lactam', 'macrolide')) %>%
  group_by(drug, state, year) %>%
  summarize(n_rx = sum(n_rx * n_member),
            n_member = sum(n_member)) %>%
  summarize_at(vars(n_rx, n_member), function(x) as.integer(round(mean(x)))) %>%
  ungroup() %>%
  filter(state %in% maup_res$state)

census_regions = read_tsv('~/grad/proj/medicare/db/census-regions/census-regions.tsv') %>%
  select(state, region, division=division_name)

maup_ur = inner_join(maup_use, maup_res, by=c('drug', 'state')) %>%
  select(-drug) %>%
  left_join(census_regions, by='state') %>%
  filter(bugdrug == 'Ec/q')
```

```{r}
maup_state = maup_ur %>%
  mutate(piy = n_rx / n_member * 1000, pct_res = 100 * n_res / n_isolates) %>%
  group_by(bugdrug) %>%
  do(tidy(lm(pct_res ~ piy, data=.), conf.int=TRUE)) %>%
  ungroup()

maup_lm = function (df) {
  df %>%
    group_by(bugdrug, add=TRUE) %>%
    summarize_at(vars(n_rx, n_member, n_res, n_isolates), sum) %>%
    mutate(piy = n_rx / n_member * 1000, pct_res = 100 * n_res / n_isolates) %>%
    group_by(bugdrug) %>%
    do(tidy(lm(pct_res ~ piy, data=.), conf.int=TRUE)) %>%
    ungroup()
}

maup_region = maup_ur %>%
  group_by(region) %>%
  maup_lm()

maup_division = maup_ur %>%
  group_by(division) %>%
  maup_lm()

group_sample_idx = function(n_units, n_groups) {
  stopifnot(n_units >= n_groups)
  # each group must appear at least once
  fixed_idx = 1:n_groups
  # remaining units assigned to groups at random
  random_idx = sample(n_groups, n_units - n_groups, replace=TRUE)
  # mix up the fixed and random indices
  sample(c(fixed_idx, random_idx))
}

group_lm = function(ur, n_groups) {
  n_state = length(unique(ur$state))
  group = group_sample_idx(n_state, n_groups)
  
  ur %>%
    mutate(group = group) %>%
    group_by(group) %>%
    maup_lm()
}

group_lm_simulation = function(ur, n_groups, n_iterations) {
  lapply(1:n_iterations, function(i) group_lm(ur, n_groups)) %>%
    bind_rows() %>%
    filter(term == 'piy') %>%
    mutate(n_groups = n_groups)
}

list_n_groups = c(4, 9, 15, 20, 25, 30, 35, 40)
n_iterations = 100

maup_group = lapply(list_n_groups, function(n) group_lm_simulation(maup_ur, n, n_iterations)) %>%
  bind_rows()
```

```{r}
# random zones
state_centers = read_tsv('../db/state_centers.tsv') %>%
  filter(state %in% maup_ur$state)

zone_lm = function(ur, k) {
  # select k states to be the centers of the zones
  centers = sample_n(state_centers, k) %>%
    select(zone=state, long, lat)

  # then cluster the states into those zones
  zones = crossing(state_centers, centers) %>%
    mutate(dist = sqrt((long - long1) ** 2 + (lat - lat1) ** 2)) %>%
    group_by(state) %>%
    filter(dist == min(dist)) %>%
    ungroup() %>%
    select(zone, state)

  # group the states and do the analysis
  ur %>%
    left_join(zones, by='state') %>%
    group_by(zone) %>%
    maup_lm()
}

zone_simulation = function(ur, n_groups, n_iterations) {
  lapply(1:n_iterations, function(i) zone_lm(ur, n_groups)) %>%
    bind_rows() %>%
    mutate(n_groups = n_groups)
}

maup_zone = lapply(list_n_groups, function(x) zone_simulation(maup_ur, x, n_iterations)) %>%
  bind_rows()
```

```{r}
maup_combined = bind_rows(
  maup_group %>% mutate(type='group'),
  maup_zone %>% mutate(type='zone')
)

maup_combined %>%
  filter(term == 'piy', n_groups < 44) %>%
  group_by(type, n_groups) %>%
  summarize(mean_slope = mean(estimate),
            sd_slope = sd(estimate)) %>%
  ungroup() %>%
  ggplot(aes(n_groups, mean_slope, color=type)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin=mean_slope-sd_slope, ymax=mean_slope+sd_slope)) +
  #geom_errorbar(inherit.aes=FALSE, data=filter(maup_state, term=='piy'), aes(x=44, ymin=conf.low, ymax=conf.high)) +
  geom_point(inherit.aes=FALSE, data=filter(maup_state, term=='piy'), aes(x=44, y=estimate)) +
  geom_point(inherit.aes=FALSE, data=filter(maup_division, term=='piy'), aes(x=9, estimate)) +
  geom_point(inherit.aes=FALSE, data=filter(maup_region, term=='piy'), aes(x=4, estimate)) +
  xlab('number of aggregations') +
  ylab('mean regression slope (SD)') +
  coord_cartesian(ylim=c(-0.15, 0.45))
```

